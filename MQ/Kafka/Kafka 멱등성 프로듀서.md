# Kafka 멱등성 프로듀서
### 멱등성
* 동일한 작업을 여러 번 수행하더라도 동일한 결과가 나타나는 특성
* 멱등성을 지닌 프로듀서는 같은 데이터를 여러 번 전송하더라도 해당 데이터가 Kafka 클러스터에 단 한 번만 저장되도록 보장

### 메시지 전송 방식
1. **최대 한 번 (At most once)**
   * 메시지가 한 번만 전송되며, 재전송은 발생하지 않는다. 이로 인해 메시지가 유실될 가능성이 있다.
2. **최소 한 번 (At least once)**
   * 메시지가 반드시 전송되며, 최소한 한 번 이상은 전송이 보장된다. 이 과정에서 메시지가 중복으로 전송될 수 있다.
3. **정확히 한 번 (Exactly once)**
   * 메시지가 정확히 한 번만 전송되며, 재전송은 일어나지 않는다. 따라서 메시지가 유실되지 않는 것이 보장된다.

### 프로듀서 Acknowledgement (acks)
* acks 설정은 프로듀서가 브로커에게 메시지를 보낸 후 받는 응답의 수준을 결정한다.
   * **acks = 0**
     * 프로듀서가 브로커에게 메시지를 보내고, 어떠한 응답도 기다리지 않는다.
     * 가장 빠른 전송 속도를 제공하지만, 메시지가 실제로 브로커에게 도착했는지 확인할 수 없어 메시지 유실의 위험이 있다.
     * 최대 한 번 (At most once) 전송 전략에 해당한다.
     * 프로듀서는 메시지를 전송한 순간 성공했다고 간주한다.
   * **acks = 1**
     * 프로듀서가 리더 브로커가 메시지를 받았을 때만 응답을 받는다.
     * 메시지가 최소 한 브로커에 저장되었음을 보장하지만, 이 브로커가 장애가 발생하면 메시지가 손실될 수 있다.
     * 최소 한 번 (At least once) 전송 전략에 해당한다.
     * 프로듀서는 리더 브로커로부터 확인 응답을 받는 시점에 성공했다고 간주한다.
   * **acks = all (acks = -1)**
     * 프로듀서가 리더 브로커 뿐만 아니라 모든 레플리카 브로커에 의해 메시지가 처리되었다는 확인을 받을 때까지 기다린다.
     * 데이터 신뢰성을 최대화하지만, 전송 속도가 느리다는 점이 있다.
     * 정확히 한 번 (Exactly once) 전송 전략에 해당한다.
     * 프로듀서는 리더 브로커를 포함한 모든 레플리카 브로커들로부터 확인 응답을 받은 시점에 성공했다고 간주한다.

### 멱등성 보장 설정
* 정확히 한 번 (Exactly once)을 구현하기 위해서는 acks 설정 뿐만 아니라 idempotent 설정 또는 브로커의 max.in.flight.requests.per.connection 설정, min.insync.replicas 설정, retries 설정도 같이 되어야 한다.
* 멱등성을 보장하기 위한 설정
* enable.idempotence
  * 프로듀서가 레코드 쓰기 작업을 단 한 번만 허용할 것인지를 결정
  * `true`로 설정해야 멱등성을 보장한다.
  * enable.idempotence 설정을 활성화하기 위해서는 아래 설정의 구성을 따라야 한다.
  * acks
    * `all` 또는 `-1` 로 설정
  * max.in.flight.requests.per.connection
    * 한 번에 몇 개의 요청을 전송할지 결정
    * `1 이상 5 이하`로 설정
    * 5 이상으로 설정했을 경우 ConfigException 이 발생한다.
  * retries
    * 메시지를 전송하기 위해 재시도되는 횟수
    * `0 이상`으로 설정
  * min.insync.replicas
    * 동기화하는 레플리카 수
    * `acks=all` 일 경우 보통 `2`로 설정

### 멱등성 프로듀서의 한계
* 멱등성 프로듀서는 동일한 세션 내에서만 정확히 한 번의 전달을 보장한다.
  * 동일한 세션이란 PID (Producer ID)의 생명주기를 의미한다.
* 만약 멱등성 프로듀서로 작동하는 프로듀서 애플리케이션에 문제가 발생해 다시 시작하면 PID가 변경된다.
* 동일한 데이터를 전송하더라도, PID가 바뀌면 브로커는 다른 프로듀서 애플리케이션이 다른 데이터를 보냈다고 판단한다.
* 멱등성 프로듀서는 **장애가 발생하지 않는 상황에서만** 데이터를 정확히 한 번 적재한다는 점을 명심한다.

### 멱등성 프로듀서 사용 시 오류
* 멱등성 프로듀서는 시퀀스 번호를 0부터 시작하여 데이터를 전송할 때마다 1씩 증가시킨다.
* 브로커는 멱등성 프로듀서가 전송한 데이터의 PID와 시퀀스 번호를 확인하는 과정에서 시퀀스 번호가 일관성을 유지하지 않는 경우 OutOfOrderSequenceException을 발생시킬 수 있다.
