# JPA Entity 생명주기
### 영속성 컨텍스트
* **엔티티를 영구 저장**하는 환경
* 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스같은 역할을 한다.
* 엔티티 매니저를 통해 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.
* **영속성 컨텍스트의 특징**
  * 엔티티 매니저를 생성할 때 하나 만들어진다.
  * 엔티티 매니저를 통해 영속성 컨텍스트에 접근하고 관리할 수 있다.
### 엔티티 생명주기 (Entity LifeCycle)
![entity-lifeCycle](https://github.com/lgm1007/TIL/assets/57981691/5077d8a1-ca96-4cc2-89fc-30aa1f5cb49f)  
#### 비영속 (New / Transient)
* 순수한 객체 상태이며, **영속성 컨텍스트와 관련 없는 상태**
```java
Member member = new Member();
```
#### 영속 (Managed)
* 엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장해 **영속성 컨텍스트가 관리하는 상태**
```java
entityManager.persist(member);
```
#### 준영속 (Detached)
* 영속성 컨텍스트에 저장되었다가 분리된(detached) 상태
```java
entityManager.detach(member);

entityManager.close();
entityManager.clear();
```
* `close()`
  * 영속성 컨텍스트를 종료하고 관리하던 모든 엔티티가 준영속 상태가 된다.
* `clear()`
  * 영속성 컨텍스트를 초기화하여 해당 영속성 컨텍스트에 존재하는 모든 엔티티를 준영속 상태로 만든다.
  * 모든 것이 초기화되어서 새로 만든 영속성 컨텍스트 상태와 동일하다.
* **준영속 특징**
  1. 거의 비영속 상태와 동일하다.
     * 영속성 컨텍스트가 관리하지 않기 때문에 제공하는 어떤 기능도 동작하지 않는다.
  2. 식별값을 보유하고 있다.
      * 비영속 상태는 식별값이 없을 수 있지만 준영속 상태는 영속 상태였기 때문에 반드시 식별자를 보유하고 있다.
  3. 지연 로딩(Lazy Loading) 불가
      * 지연 로딩은 실제 객체 대신 **프록시 객체를 로딩**하고 해당 객체를 실제 사용 시 **영속성 컨텍스트를 통해 데이터를 불러오는** 것이다.
      * 더 이상 영속성 컨텍스트가 관리하지 않으므로 지연 로딩 시 문제가 발생한다.
#### 병합 (merge)
* 준영속 상태의 엔티티를 **다시 영속상태로 변환**한다.
* 준영속 상태의 엔티티를 받아 가지고 있는 정보로 새 영속 상태의 엔티티를 반환한다.
```java
Member mergeMember = entityManager.merge(member);
```
#### 삭제 (remove)
* 엔티티를 **영속성 컨텍스트와 데이터베이스에서 삭제**
```java
entityManager.remove(member);
```
