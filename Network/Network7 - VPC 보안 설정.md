## VPC 방화벽 (Security Group / Network ACL)
- 해당 서비스들은 흔히 특정 IP에 대해, 또는 외국에서 접속을 못하게 하는 방화벽을 설정한다고 보면 된다.
- 대표적으로 Security Group과 Network ACL 2가지 서비스가 있다.
- **Network ACL**은 도식화에서 주로 서브넷의 위에 위치하는데, 서브넷에 오가는 트래픽을 제어하는 역할을 하기 때문이다.
- **Security Group**은 도식화에서 주로 서브넷의 안에 위치하는데, 인스턴스의 트래픽을 제어하는 역할을 하기 때문이다.
    - 다수의 인스턴스가 하나의 Security Group을 쓰거나, 각자의 Security Group을 쓸 수 있다.

## Security Group (보안그룹)
- 보안그룹은 인스턴스에 대한 인바운드 & 아웃바운드 트래픽을 제어하는 가상 방화벽 역할을 한다.
- 여기서 말하는 인스턴스는 EC2 인스턴스 뿐만 아니라, VPC 내에 탑재될 수 있는 수많은 가상 컴퓨터를 의미한다.
- 즉 EC2, RDS, ELB, VPC Interface EndPoint 등도 포함될 수 있다.
- 엄밀히 말하자면 VPC 내에서 Elastic Network Interface (ENI) 를 갖는 모든 서비스에 탑재될 수 있다. 보안그룹은 인스턴스의 ENI에 적용되기 때문이다.
    - **ENI**: 네트워크 인터페이스와 같은 의미, 인스턴스가 만들어 낸 트래픽을 네트워크로 전송하거나, 네트워크에서 들어온 트래픽을 수신한다.

### 보안그룹의 특징
1. 보안그룹은 인바운드 규칙과 아웃바운드 규칙으로 나뉜다.
2. **허용 규칙**만 생성 가능
    - 블랙리스트처럼 특정 차단은 불가능. 일부 허용을 통해 간접적으로 차단은 가능
    - 무언가를 차단하는 규칙은 Network ACL에서 생성
3. 기본적으로 모든 보안그룹의 아웃바운드 규칙은 모든 아웃바운드 트래픽 허용
4. 보안그룹은 인스턴스 단위로 설정
    - 하나의 인스턴스에는 하나 이상의 보안그룹 설정 가능
    - 최대 5개 동시 적용 가능
5. 각 인스턴스에 각각 서로 다른 보안그룹도 할당 가능
6. 설정된 인스턴스는 연결되어 있는 보안그룹의 모든 룰에 적용받는다.
7. 상태를 저장하여 한 번 인바운드를 통과하는 트래픽은 아웃바운드의 규칙 적용을 받지 않는다. (Stateful)
8. 상태를 저장하여 한 번 아웃바운드를 통과하는 트래픽은 인바운드 규칙 적용을 받지 않는다. (Stateful)

### 보안그룹: Stateful
- 보안그룹의 가장 큰 특징
- 보안그룹 HTTP/HTTPS/SSH 의 허용은 인바운드에만 적용되어있다고 하자.
    - 보안그룹은 Stateful이라 인바운드에만 허용시켜두면 3개 프로토콜은 아웃바운드 규칙에 영향을 받지 않고 트래픽이 왕래한다는 것
    - 즉 인바운드를 통해 온 트래픽 = 허용된 트래픽 이라는 상태를 기억하는 것, 트래픽이 빠져나갈 때 허용된 트래픽인 것을 기억하기 때문에 아웃바운드 규칙에 영향을 받지 않는다.

## Network ACL (네트워크 엑세스 제어)
- 네트워크 엑세스 제어는 서브넷의 접근 제어 목록을 책임진다.
- 보안그룹이 인스턴스의 접근 제어 목록이라면, 네트워크 엑세스 제어는 **서브넷을 오고 가는 모든 트래픽을 제어**하는 역할을 한다.
- 네트워크 엑세스 제어는 **서브넷** 단위로 적용되기 때문에, 서브넷 내의 모든 트래픽은 Network ACL의 규칙 적용을 받게 된다.
- 서브넷이 들어있는 가용 영역에 가기 전 보안 검문소 역할

### 네트워크 엑세스 제어의 특징
1. 인바운드 규칙과 아웃바운드 규칙으로 나뉜다.
2. 여러 서브넷에 적용 가능하다. 단, **서브넷은 하나의 Network ACL만 연결 가능**하다.
3. 허용 규칙뿐만 아니라 **거부 규칙도 생성 가능**하다.
4. 규칙에 숫자가 매겨지며, **가장 작은 숫자를 지니는 규칙이 우선적**으로 적용된다.
5. 네트워크 엑세스 제어 규칙 목록은 인바운드, 아웃바운드 최대 20개까지 지정 가능하다.
6. 상태를 저장하지 않아 한 번 인바운드를 통과하는 트래픽은 아웃바운드 규칙을 적용받는다. (Stateless)
7. 상태를 저장하지 않아 한 번 아웃바운드를 통과하는 트래픽은 인바운드 규칙을 적용받는다. (Stateless)

### 네트워크 엑세스 제어: Stateless
- Network ACL은 이전 상태를 기억하지 않는다.
- 트래픽의 신뢰가 있건 없건 융통성 없게 무조건 규칙 문서를 보고 판단한다.
- 인바운드 규칙은 허용으로 적용되어 유입된 트래픽이 다시 밖으로 나가기 위해서는 아웃바운드 규칙을 적용받아야 한다.

## Security Group vs Network ACL
우선 서브넷 단위의 Network ACL로 가장 먼저 트래픽이 들어올 것이다.  
이 때, Network ACL은 모든 트래픽을 허용하되, 차단할 필요가 있는 IP를 골라 차단하는 식으로 설정한다.  
그리고 인스턴스 단위의 보안그룹을 사용해 각 인스턴스에 허용되어야 할 프로토콜과 포트를 각각 지정한다.  
Network ACL은 프로토콜과 포트 설정에 관여하지 않고, 이 부분은 전적으로 보안그룹에게 맡긴다.

| 보안그룹                                          | Network ACL                                        |
| --------------------------------------------- | -------------------------------------------------- |
| 인스턴스 레벨에서 운영                                  | 서브넷 레벨에서 운영                                        |
| 허용 규칙만 지원                                     | 허용 및 거부 규칙 지원                                      |
| 상태 저장 (Stateful)<br>규칙에 관계없이 반환 트래픽이 자동으로 허용됨 | 상태 비저장 (Stateless)<br>반환 트래픽이 규칙에 의해 명시적으로 허용되어야 함 |
| 트래픽 허용을 결정하기 전에 모든 규칙을 평가함                    | 트래픽 허용 여부를 결정할 때 번호가 가장 낮은 규칙부터 순서대로 규칙 처리         |
