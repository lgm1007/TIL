## ELB (Elastic Load Balancer) 란?
- ELB 란 애플리케이션 트래픽을 여러 대상에 자동으로 분산시켜 안정적인 AWS 서버 환경을 운용하는 데 도움을 주는 서비스이다.
- EC2 뿐만 아니라 컨테이너, AWS Lambda 등 다양한 서비스와 연계하여 부하를 분배할 수 있다.
- ELB는 서로 다른 EC2 인스턴스에 대한 하나의 엔드포인트를 제공한다. 따라서 사용자는 실제 요청이 되는 백엔드 인스턴스에 대한 고려 없이, 동일한 엔드포인트로 요청을 전송할 수 있다.
- 부하 분산뿐만 아니라 부하 분산 대상에 대한 헬스 체크, 헬스 체크를 통한 다운 서버 제외, 고정 세션, SSL 암복호화 등이 가능하다.

![elb-users-endpoint](https://i.imgur.com/rbqio93.png)

## Load Balancing 기능
ELB를 이해하기 위해 우선 로드 밸런싱이 어떤 역할을 하는지 알아본다.  
(ELB (Elastic Load Balancer)은 AWS에서 운용하는 로드 밸런서를 지칭하는 것)

#### 1. 부하 분산 처리
- 말 그대로 부하를 분산해 **트래픽이 과도하게 몰려 서비스가 중단되는 현상을 막기** 위한 기술

#### 2. 엔드포인트 역할 제공
- 로드 밸런서는 스케일 아웃에 대한 **하나의 엔드포인트**를 제공한다.
- 사용자 입장에서는 스케일 아웃된 다수의 인스턴스를 하나하나 접속하면서 관리하기 힘들다.
- 오토 스케일링 그룹은 혁신적인 기술이지만 별도의 로드 밸런싱 및 별도의 부하 분산 서비스가 없이는 활용 불가능하다.
- 로드 밸런서에서 트래픽을 하나의 경로로 받아 다수의 인스턴스에 분산하게 되어, 사용자 입장에서는 하나의 주소로 관리할 수 있게 된다.

## 오토 스케일링과 조합
- **오토 스케일링**은 트래픽이 몰릴 때 인스턴스 수를 자동으로 늘리고, 트래픽이 적을 때 인스턴스 수를 감소시키는 등 서버 사이즈를 조절해 서비스가 원활히 유지되도록 하는 서비스
- **ELB**는 오토 스케일링을 통해 늘린 수만 개의 인스턴스들에게 부하를 분산하는 서비스
- 즉 이 둘은 같이 유기적으로 연동되어 EC2를 보다 효과적으로 이용할 수 있게 한다. AWS 매니저에서 같이 설정하는 편이다.

## ELB 내부 구성 요소
- ELB는 VPC에 탑재되어 사용자의 요청을 받고 이를 VPC 내의 리소스에 적절히 부하 분산한다.
- ELB는 외부의 요청을 받아들이는 **리스너** (Listener) 와 요청을 분산/전달할 리소스의 집합인 **대상 그룹** (Targer Group) 으로 구성된다.
- ELB는 다수의 리스너와 대상 그룹을 거느릴 수 있다.

### 리스너
- 리스너는 프로토콜과 포트를 기반으로 **요청을 받아 검사**하고 이를 적절한 **타겟으로 전달**하는 기능을 수행한다.
- 리스너는 외부 요청을 받아들이기 때문에 모든 로드 밸런서는 **최소 1개 이상**의 리스너를 필요로 하며, **최대 10개**까지 설정할 수 있다.
- SSL 인증서를 게시하여 SSL 암복호화를 할 수도 있다.

### 규칙
- 리스너 규칙은 리스너와 타겟 그룹 사이의 **트래픽 분배를 위한 라우팅 규칙**에 해당한다.
- 규칙은 우선순위, 액션, 조건 등의 정보를 담고 있으며, Path, Host, HTTP Header, Source IP, Query Parameter 등 **다양한 조건이 만족되었을 때, 지정된 액션을 수행**하는 방식으로 작동한다.

### 대상 그룹
- 대상 그룹은 리스너가 전달한 요청을 처리하기 위한 **부하분산 대상들의 모임**이다.
- ELB가 분산할 때 어디로 분산할 것이냐를 모은 그룹들
- 대상 그룹에 등록된 EC2의 각종 정보가 있고, 이 EC2가 전달받은 요청을 처리할 수 있는지 체크하는 **헬스 체크** 기능과, 이 대상 그룹에 요청 처리가 가능한 EC2가 몇 개인지 등 확인하는 처리에 관련된 **모니터링** 기능이 있다.

### 유휴 제한 시간 (Connection Time Out)
- 사용자가 ELB를 거쳐 EC2에 접근하여 서비스를 접근하면 커넥션 (Connection) 이 생성된다. 이 커넥션을 통해 사용자가 EC2와 통신한다.
- 더 이상의 통신이 없을 때, 유휴 제한 시간이 작동한다.
- 즉 유휴 제한 시간이란 **일정 시간 동안 통신이 없을 때 커넥션을 삭제할 것인가**를 뜻한다.

## ELB 기능 및 장점
### 고가용성 및 탄력성 (자동 확장/축소)
- ELB는 접속 부하에 맞게 **자동적으로 리소스의 확장/축소**를 수행한다.
- 대량의 요청이 발생해도 ELB로 인해 병목 현상이 발생하는 상황은 거의 일어나지 않는다.
- 하지만 순간적으로 요청이 증가하면 리소스 자동 확장까지 일정 시간이 걸리므로, 일시적으로 병목 현상이 걸릴 수 있다.
- 수신되는 트래픽을 **단일 가용 영역이나 또는 여러 가용 영역의 EC2 인스턴스 전체에 걸쳐 배포**할 수 있다.

### 도메인 기반 접근
- ELB는 지속적으로 IP 주소가 바뀌며 **IP 고정 불가능하여 항상 도메인 기반**으로 사용해야 한다.
- 단 네트워크 로드 밸런서 (NLB)는 탄력적 IP로 고정 가능하다.

### SSL 지원
- SSL 암호화를 간편하게 구성 지원한다.
- SSL 증명서를 인스턴스에 따라 설정할 필요가 없어진다. SSL 증명서를 ELB에서만 관리하면 되므로, 운용 측면에서 장점이다.

### 고정 세션 (Sticky Session)
- 만약 서버가 여러 대일 경우, 사용자가 서버 인스턴스에 접근해 로그인을 하려고 할 때 어느 서버로 접근될 지 모른다.
- A 인스턴스로 로그인했다가 다시 서버에 접근하려는데 로드밸런싱에 의해 B 인스턴스로 접속해 세션이 없어 또 로그인해야 하는 상황이 올 수 있다.
- 유저에게 쿠키를 생성해 접근 정보를 갖도록 하고, ELB에서도 공간을 만들어 정보를 저장한다.
- 즉 **사용자 세션을 특정 인스턴스에 고정시켜** 자신이 이전에 접속한 인스턴스로 다시 접속할 수 있도록 한다.

## ELB 서비스 종류
ELB는 대표적으로 4가지 로드밸런서가 있다.

1. Classic Load Balancer (CLB)
2. Application Load Balancer (ALB)
3. Network Load Balancer (NLB)
4. Gateway Load Balancer (GLB)

### Classic Load Balancer (CLB)
- 가장 기본적인 형태이자 초기에 제공되던 서비스
- 서버의 주소가 바뀌면 로드 밸런서를 새로 생성해야하며 하나의 주소에 하나의 대상 그룹으로 밖에 못 보낸다.
- 데이터를 수정/변경할 수 없어 포트, 헤더 등의 변경을 못한다.
- 현재에는 CLB를 많이 사용하지 않아 레거시로 분류되고, 주로 NLB 또는 ALB를 사용하여 구성하는 추세이다.

### Application Load Balancer (ALB)
- OSI 7 계층의 7번 째 계층에 해당하는 Application Layer 를 다루는 로드 밸런서이다.
    - Application Layer에는 HTTP/HTTPS, FTP, DNS, DHCP, Web Socket 등 다양한 프로토콜이 존재한다.
- ALB는 단순 부하 분산뿐만 아니라 HTTP/HTTPS의 헤더 정보를 이용해 부하 분산을 할 수 있다.
    - HTTP 헤더 정보를 보고 해당 요청을 어느 대상그룹으로 보낼지 판단할 수 있다.
- ALB는 경로 (Path) 뿐 아니라 포트에 따라 다른 대상그룹으로 매핑할 수 있다.
    - 각각의 포트에 따라 다르게 구성할 수도 있다.
- ALB는 대상을 EC2 인스턴스 뿐 아니라 람다, IP 로도 연결이 가능하다.
    - 특정한 요청에 대해선 서버 없이 직접 응답메시지를 작성할 수 있어 MSA를 구성하기 좋다.
- SSL 인증서를 탑재할 수 있어 대상그룹의 EC2를 대신하여 SSL 암복호화를 대신할 수 있다.
- ALB는 IP 주소가 변동되기 때문에 클라이언트에서 액세스 할 ELB의 DNS Name을 이용한다.

### Network Load Balancer (NLB)
- NLB는 OSI 7 계층의 4번 째 계층에 해당하는 Transport Layer을 다루는 로드 밸런서이다.
- NLB는 **TCP와 UDP를 사용하는 요청**을 받아들여 부하 분산을 실시한다.
- NLB는 ALB보다 성능이 더 빠르기 때문에 **고성능을 요구하는 환경에서의 부하 분산에 적합**한 솔루션이다.
    - NLB에 비해 7계층까지 확인하는 ALB의 기능이 더 많다. 하지만 NLB는 ALB 보다 빠르다.
    - **단순한 라우팅이 필요하고, 트래픽이 극도로 많은 경우**에는 ALB 보다 NLB를 사용하는 것이 적합하다.
- EIP로 공인 IP를 고정할 수 있다. 따라서 ALB와 달리 로드 밸런서에 접근할 때 IP나 DNS 둘 다 사용 가능하다.

|               | ALB                 | NLB      |
| ------------- | ------------------- | -------- |
| 프로토콜          | HTTP, HTTPS, HTTP/2 | TCP, TLS |
| 쿠키기반 고정 세션 지원 | O                   | X        |
| 대상그룹 지원       | O                   | O        |
| WebSocket 지원  | O                   | X        |
| 대상으로 IP 주소 지원 | O                   | O        |
| 콘텐츠 기반 라우팅 지원 | O                   | X        |
| 고정 IP 지원      | X                   | O        |

### Gateway Load Balancer (GLB)
- GLB는 OSI 7 계층의 세 번째 계층인 Network Layer에서 작동한다.
- GLB를 사용하면 **방화벽, 침입 탐지 및 방지 시스템, 심층 패킷 검사 시스템**과 같은 가상 어플라이언스 (Appliances)를 배포, 확장, 관리할 수 있다.
- 트래픽이 EC2에 도달하기 전에 **먼저 트래픽을 검사 및 분석하거나 인증, 로깅하는 작업**을 수행할 수 있는 서비스
- 일반적인 로드 밸런서 역할과는 다른, **트래픽을 체크**하는 역할
